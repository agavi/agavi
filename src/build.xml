<?xml version="1.0"?>
<project name="agavi" basedir="." default="main">
	<taskdef classname="${agavi.dir}.etc.phing.AgaviTestTask" name="agavitest"/>

  <!-- fileset for -dist files -->
  <fileset dir="." id="distfiles">
		<include name="**/*-dist"/>
  </fileset>

  <!-- main target -->
	<target name="main" description="main target">
		<echo msg="available targets: " /> 
		<echo msg="  project    - create a project" />
		<echo msg="  module     - create a module" />
		<echo msg="  action     - create an action" />
		<echo msg="  test       - run unit tests" />
	</target>

	<target name="test" description="run unit tests">
		<property name="agavidir" value="${agavi.dir}" />
	  <property name="testdir" value="${project.dir}/tests"  />
	  <property name="from" value=""  />
  	<property name="reporter" value="text"  />
  	<property name="outfile" value=""  />
		<agavitest exit="true" testdir="${project.dir}/tests" agavidir="${agavi.dir}" startpoint="${from}" reporter="${reporter}" outfile="${outfile}"/>
	</target>

	<target name="project" description="create a new project">
		<input propertyname="project.dir" promptChar="?" message="Full path to your new project (no trailing slash!)"/>
		<mkdir dir="${project.dir}"/>
		<mkdir dir="${project.dir}/www"/>
		<copy file="code_templates/index.php.tmpl" tofile="${project.dir}/www/index.php">
			<filterchain>
				<replacetokens begintoken="%%" endtoken="%%">    
					<token key="PATH_TO_AGAVI" value="${project.basedir}"/>
					<token key="PATH_TO_PROJECT" value="${project.dir}/webapp"/>
				</replacetokens>
			</filterchain>
		</copy>
		<mkdir dir="${project.dir}/www/modpub"/>
		<mkdir dir="${project.dir}/webapp"/>
		<mkdir dir="${project.dir}/webapp/cache"/>
		<copy file="code_templates/config.php.tmpl" tofile="${project.dir}/webapp/config.php">
			<filterchain>
				<replacetokens begintoken="%%" endtoken="%%">    
					<token key="PATH_TO_AGAVI" value="${project.basedir}"/>
					<token key="PATH_TO_PROJECT" value="${project.dir}/webapp"/>
				</replacetokens>
			</filterchain>
		</copy>
		<mkdir dir="${project.dir}/webapp/config"/>
		<copy todir="${project.dir}/webapp/config">
			<fileset dir="code_templates/config">
				<include name="*.ini"/>
				<include name="*.conf"/>
			</fileset>
		</copy>
		<mkdir dir="${project.dir}/webapp/lib"/>
		<mkdir dir="${project.dir}/webapp/lib/models"/>
		<mkdir dir="${project.dir}/webapp/modules"/>
		<mkdir dir="${project.dir}/webapp/templates"/>

		<!-- tests/ directory -->
		<mkdir dir="${project.dir}/tests" />
		<mkdir dir="${project.dir}/tests/lib" />
		<mkdir dir="${project.dir}/tests/lib/models" />
		<mkdir dir="${project.dir}/tests/modules" />
		
		<input propertyname="modules" promptChar="?" defaultValue="Default" message="Modules for your project (no whitespace, comma seperated)"/>
		<foreach list="${modules}" param="module" target="buildmodule">
			<property name="project.dir" value="${project.dir}/webapp" override="true"/>
			<property name="test.dir" value="${project.dir}/tests" override="true"/>
		</foreach>
	</target>

	<target name="module" description="create a new module">
		<available file="${project.dir}/modules" type="dir" property="is_webapp" value="true"/>
		<fail unless="is_webapp" message="Must be called in the root of a webapp directory."/>
		<input propertyname="module" promptChar="?" message="Module Name"/>
		<phingcall target="buildmodule"/>
	</target>

	<target name="buildmodule">
		<property name="prefix" value="${project.dir}/modules/${module}/"/>
		<mkdir dir="${prefix}"/>
		<mkdir dir="${prefix}actions"/>
		<mkdir dir="${prefix}config"/>
		<copy file="code_templates/module.ini.tmpl" tofile="${prefix}config/module.ini">
			<filterchain>
				<replacetokens begintoken="%%" endtoken="%%">    
					<token key="MODULE" value="${module}"/>
				</replacetokens>
			</filterchain>
		</copy>
		<mkdir dir="${prefix}models"/>
		<mkdir dir="${prefix}templates"/>
		<mkdir dir="${prefix}views"/>
		
		<property name="testprefix" value="${test.dir}/modules/${module}/"/>
		<mkdir dir="${testprefix}"/>
		<mkdir dir="${testprefix}actions"/>
		<mkdir dir="${testprefix}models"/>
		<mkdir dir="${testprefix}views"/>
		
		<input propertyname="actions" promptChar="?" defaultValue="Index" message="Actions for ${module} (no whitespace, comma seperated)"/>
		<foreach list="${actions}" param="action" target="buildaction"/>
		<input propertyname="models" promptChar="?" message="Models for ${module} (no whitespace, comma seperated)"/>
		<foreach list="${models}" param="model" target="buildmodel"/>
	</target>

	<target name="action" description="create a new action">
		<available file="${project.dir}/config/module.ini" property="is_module" value="true"/>
		<fail unless="is_module" message="Must be called in the root of a module directory."/>
		<property name="module" value="${cwd_name}"/>
		<input propertyname="action" promptChar="?" defaultValue="Index" message="Action Name"/>
		<property name="prefix" value="${project.dir}/"/>
		<property name="testprefix" value="${test.dir}/"/>
		<phingcall target="buildaction"/>
	</target>

	<target name="buildaction">
		<copy file="code_templates/Action.class.php.tmpl" tofile="${prefix}actions/${action}Action.class.php">
			<filterchain>
				<replacetokens begintoken="%%" endtoken="%%">    
					<token key="MODULE" value="${module}"/>
					<token key="ACTION" value="${action}"/>
				</replacetokens>
			</filterchain>
		</copy>
		
		<copy file="code_templates/ActionTest.class.php.tmpl" tofile="${testprefix}actions/${action}ActionTest.class.php">
			<filterchain>
				<replacetokens begintoken="%%" endtoken="%%">    
					<token key="MODULE" value="${module}"/>
					<token key="ACTION" value="${action}"/>
				</replacetokens>
			</filterchain>
		</copy>

		<input propertyname="views" promptChar="?" defaultValue="Success" message="Views for ${action} (no whitespace, comma seperated)"/>
		<foreach list="${views}" param="view" target="buildview"/>
	</target>

	<target name="buildview">
		<copy file="code_templates/View.class.php.tmpl" tofile="${prefix}views/${action}${view}View.class.php">
			<filterchain>
				<replacetokens begintoken="%%" endtoken="%%">    
					<token key="MODULE" value="${module}"/>
					<token key="ACTION" value="${action}"/>
					<token key="VIEW" value="${view}"/>
				</replacetokens>
			</filterchain>
		</copy>

		<copy file="code_templates/ViewTest.class.php.tmpl" tofile="${testprefix}views/${action}${view}ViewTest.class.php">
			<filterchain>
				<replacetokens begintoken="%%" endtoken="%%">    
					<token key="MODULE" value="${module}"/>
					<token key="ACTION" value="${action}"/>
					<token key="VIEW" value="${view}"/>
				</replacetokens>
			</filterchain>
		</copy>
		
		<touch file="${prefix}templates/${action}${view}.php"/>
	</target>

	<target name="model" description="create a new model">
		<input propertyname="model" promptChar="?" defaultValue="${module}" message="Model Name"/>
		<property name="prefix" value="${project.dir}/"/>
		<property name="testprefix" value="${test.dir}/"/>
		<phingcall target="buildmodel"/>
	</target>

	<target name="buildmodel">
		<copy file="code_templates/Model.class.php.tmpl" tofile="${prefix}models/${model}Model.class.php">
			<filterchain>
				<replacetokens begintoken="%%" endtoken="%%">    
					<token key="MODULE" value="${module}"/>
					<token key="MODEL" value="${model}"/>
				</replacetokens>
			</filterchain>
		</copy>

		<copy file="code_templates/ModelTest.class.php.tmpl" tofile="${prefix}models/${model}ModelTest.class.php">
			<filterchain>
				<replacetokens begintoken="%%" endtoken="%%">    
					<token key="MODULE" value="${module}"/>
					<token key="MODEL" value="${model}"/>
				</replacetokens>
			</filterchain>
		</copy>
	</target>

</project>
